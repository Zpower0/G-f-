/**
 * ResumeAI Pro - Core Application
 * Enterprise-grade resume builder
 */

class ResumeAI {
    constructor() {
        this.currentResume = null;
        this.userSession = null;
        this.isInitialized = false;
        this.init();
    }

    init() {
        console.log('ðŸš€ ResumeAI Pro Initializing...');
        
        // Load user session
        this.loadSession();
        
        // Initialize UI
        this.initUI();
        
        // Initialize event listeners
        this.initEvents();
        
        // Check for updates
        this.checkUpdates();
        
        this.isInitialized = true;
        console.log('âœ… ResumeAI Pro Ready');
    }

    loadSession() {
        // Try to load from localStorage
        const saved = localStorage.getItem('resumeai_session');
        if (saved) {
            try {
                this.userSession = JSON.parse(saved);
                console.log('ðŸ“ Session loaded from storage');
            } catch (e) {
                this.userSession = this.createNewSession();
            }
        } else {
            this.userSession = this.createNewSession();
        }
        
        // Generate unique ID if not exists
        if (!this.userSession.userId) {
            this.userSession.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            this.saveSession();
        }
    }

    createNewSession() {
        return {
            userId: null,
            resumes: [],
            preferences: {
                theme: 'dark',
                autoSave: true,
                fontSize: 'medium'
            },
            stats: {
                resumesCreated: 0,
                lastActive: new Date().toISOString(),
                totalTimeSpent: 0
            },
            createdAt: new Date().toISOString()
        };
    }

    saveSession() {
        if (!this.userSession) return;
        
        this.userSession.stats.lastActive = new Date().toISOString();
        localStorage.setItem('resumeai_session', JSON.stringify(this.userSession));
        
        // Update user stats
        this.updateStats();
    }

    updateStats() {
        // Increment time spent (in minutes)
        if (this.userSession.stats.lastActive) {
            const lastActive = new Date(this.userSession.stats.lastActive);
            const now = new Date();
            const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
            this.userSession.stats.totalTimeSpent += diffMinutes;
        }
    }

    initUI() {
        // Set theme
        const theme = this.userSession?.preferences?.theme || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        
        // Update theme toggle icon
        const themeToggle = document.querySelector('.theme-toggle i');
        if (themeToggle) {
            themeToggle.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }
        
        // Initialize tooltips
        this.initTooltips();
        
        // Initialize modals
        this.initModals();
    }

    initEvents() {
        // Navigation
        document.addEventListener('click', (e) => {
            const navLink = e.target.closest('[data-nav]');
            if (navLink) {
                e.preventDefault();
                const page = navLink.dataset.nav;
                this.navigateTo(page);
            }
        });

        // Theme toggle
        const themeToggle = document.querySelector('.theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => this.toggleTheme());
        }

        // Auto-save
        if (this.userSession?.preferences?.autoSave) {
            setInterval(() => this.autoSave(), 30000); // Every 30 seconds
        }

        // Before unload
        window.addEventListener('beforeunload', (e) => {
            if (this.hasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                this.autoSave();
            }
        });

        // Online/offline
        window.addEventListener('online', () => this.handleOnline());
        window.addEventListener('offline', () => this.handleOffline());
    }

    toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        
        html.setAttribute('data-theme', newTheme);
        
        // Update session
        if (this.userSession) {
            this.userSession.preferences.theme = newTheme;
            this.saveSession();
        }
        
        // Update icon
        const icon = document.querySelector('.theme-toggle i');
        if (icon) {
            icon.className = newTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }
        
        // Save to localStorage
        localStorage.setItem('resumeai_theme', newTheme);
    }

    navigateTo(page) {
        // Update active nav link
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.toggle('active', link.dataset.nav === page);
        });
        
        // Scroll to section
        const element = document.getElementById(page);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Update URL without reload
        history.pushState({ page }, '', `#${page}`);
        
        // Track page view
        this.trackEvent('navigation', { page });
    }

    createNewResume(template = null) {
        const resumeId = 'resume_' + Date.now();
        
        const newResume = {
            id: resumeId,
            title: 'My Resume',
            template: template || 'modern',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            sections: {
                personal: {
                    name: '',
                    email: '',
                    phone: '',
                    location: '',
                    linkedin: '',
                    portfolio: ''
                },
                summary: '',
                experience: [],
                education: [],
                skills: [],
                projects: [],
                certifications: []
            },
            settings: {
                fontSize: 'medium',
                fontFamily: 'inter',
                colorScheme: 'professional',
                margins: 'normal'
            }
        };
        
        // Add to session
        if (this.userSession) {
            this.userSession.resumes.push(newResume);
            this.userSession.stats.resumesCreated++;
            this.saveSession();
        }
        
        // Set as current
        this.currentResume = newResume;
        
        // Track event
        this.trackEvent('resume_created', { template: template || 'default' });
        
        return newResume;
    }

    saveResume(resumeData) {
        if (!resumeData) return;
        
        // Update resume in session
        if (this.userSession) {
            const index = this.userSession.resumes.findIndex(r => r.id === resumeData.id);
            if (index !== -1) {
                resumeData.updatedAt = new Date().toISOString();
                this.userSession.resumes[index] = resumeData;
                this.saveSession();
                
                // Show success notification
                this.showNotification('Resume saved successfully', 'success');
                
                // Track event
                this.trackEvent('resume_saved', { resumeId: resumeData.id });
            }
        }
    }

    deleteResume(resumeId) {
        if (!this.userSession) return false;
        
        const index = this.userSession.resumes.findIndex(r => r.id === resumeId);
        if (index !== -1) {
            this.userSession.resumes.splice(index, 1);
            this.saveSession();
            
            if (this.currentResume?.id === resumeId) {
                this.currentResume = null;
            }
            
            this.showNotification('Resume deleted', 'info');
            this.trackEvent('resume_deleted', { resumeId });
            
            return true;
        }
        
        return false;
    }

    exportResume(format = 'pdf') {
        // Check if ad needs to be shown
        if (typeof AdManager !== 'undefined') {
            AdManager.showAd('export').then(() => {
                this.performExport(format);
            });
        } else {
            this.performExport(format);
        }
    }

    async performExport(format) {
        if (!this.currentResume) {
            this.showNotification('No resume to export', 'error');
            return;
        }
        
        this.showNotification(`Exporting as ${format.toUpperCase()}...`, 'info');
        
        try {
            let exportData;
            
            switch (format) {
                case 'pdf':
                    exportData = await this.exportToPDF();
                    break;
                case 'docx':
                    exportData = await this.exportToDOCX();
                    break;
                case 'html':
                    exportData = await this.exportToHTML();
                    break;
                case 'txt':
                    exportData = await this.exportToTXT();
                    break;
                default:
                    throw new Error(`Unsupported format: ${format}`);
            }
            
            // Create download link
            const blob = new Blob([exportData], { type: this.getMimeType(format) });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resume_${Date.now()}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showNotification(`${format.toUpperCase()} downloaded successfully`, 'success');
            this.trackEvent('resume_exported', { format });
            
        } catch (error) {
            console.error('Export error:', error);
            this.showNotification('Export failed. Please try again.', 'error');
        }
    }

    async exportToPDF() {
        // Generate HTML for PDF
        const html = this.generateResumeHTML();
        
        // In production, this would call the backend API
        // For now, return a simple PDF structure
        return `PDF Content for: ${this.currentResume?.title || 'Resume'}`;
    }

    generateResumeHTML() {
        if (!this.currentResume) return '';
        
        const resume = this.currentResume;
        
        return `
            <!DOCTYPE html>
            <html>
            <head>
                <title>${resume.title}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .name { font-size: 28px; font-weight: bold; }
                    .section { margin-bottom: 20px; }
                    .section-title { font-size: 18px; font-weight: bold; border-bottom: 2px solid #333; margin-bottom: 10px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="name">${resume.sections.personal.name || 'Your Name'}</div>
                    <div>${resume.sections.personal.email || ''} | ${resume.sections.personal.phone || ''}</div>
                </div>
                
                <div class="section">
                    <div class="section-title">Summary</div>
                    <div>${resume.sections.summary || ''}</div>
                </div>
                
                <!-- Add more sections -->
            </body>
            </html>
        `;
    }

    getMimeType(format) {
        const mimeTypes = {
            pdf: 'application/pdf',
            docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            html: 'text/html',
            txt: 'text/plain'
        };
        
        return mimeTypes[format] || 'application/octet-stream';
    }

    showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${this.getNotificationIcon(type)}"></i>
                <span>${message}</span>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Add to container
        const container = document.getElementById('notification-container') || this.createNotificationContainer();
        container.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    getNotificationIcon(type) {
        const icons = {
            success: 'check-circle',
            error: 'exclamation-circle',
            warning: 'exclamation-triangle',
            info: 'info-circle'
        };
        return icons[type] || 'info-circle';
    }

    createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'notification-container';
        document.body.appendChild(container);
        return container;
    }

    initTooltips() {
        // Initialize tooltips on elements with data-tooltip attribute
        document.querySelectorAll('[data-tooltip]').forEach(element => {
            element.addEventListener('mouseenter', (e) => {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = e.target.dataset.tooltip;
                document.body.appendChild(tooltip);
                
                const rect = e.target.getBoundingClientRect();
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
                tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                
                e.target._tooltip = tooltip;
            });
            
            element.addEventListener('mouseleave', (e) => {
                if (e.target._tooltip) {
                    e.target._tooltip.remove();
                    e.target._tooltip = null;
                }
            });
        });
    }

    initModals() {
        // Close modal on backdrop click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
        
        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    }

    showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
        }
    }

    hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }

    autoSave() {
        if (this.currentResume && this.hasUnsavedChanges()) {
            this.saveResume(this.currentResume);
        }
    }

    hasUnsavedChanges() {
        // Implement logic to check for unsaved changes
        return false; // Simplified for now
    }

    handleOnline() {
        this.showNotification('Back online. Changes will sync.', 'success');
        // Sync any offline data
    }

    handleOffline() {
        this.showNotification('You are offline. Changes saved locally.', 'warning');
    }

    checkUpdates() {
        // Check for app updates
        const lastUpdateCheck = localStorage.getItem('last_update_check');
        const now = Date.now();
        
        if (!lastUpdateCheck || (now - lastUpdateCheck) > 86400000) { // 24 hours
            // Check for updates (simplified)
            localStorage.setItem('last_update_check', now.toString());
        }
    }

    trackEvent(eventName, data = {}) {
        // Track events for analytics
        const eventData = {
            event: eventName,
            timestamp: new Date().toISOString(),
            userId: this.userSession?.userId,
            ...data
        };
        
        // Log to console (in production, send to analytics service)
        console.log('ðŸ“Š Event:', eventData);
        
        // Save to localStorage for offline tracking
        const events = JSON.parse(localStorage.getItem('resumeai_events') || '[]');
        events.push(eventData);
        localStorage.setItem('resumeai_events', JSON.stringify(events.slice(-100))); // Keep last 100 events
    }

    getResumeTemplates() {
        return [
            { id: 'modern', name: 'Modern', category: 'Professional', color: '#6366f1' },
            { id: 'executive', name: 'Executive', category: 'Corporate', color: '#10b981' },
            { id: 'creative', name: 'Creative', category: 'Design', color: '#f59e0b' },
            { id: 'minimal', name: 'Minimal', category: 'Clean', color: '#ef4444' },
            { id: 'ats', name: 'ATS Friendly', category: 'Optimized', color: '#a855f7' }
        ];
    }

    getSampleResumes() {
        return [
            {
                title: 'Software Engineer',
                industry: 'Technology',
                experience: '5+ years',
                skills: ['JavaScript', 'React', 'Node.js', 'Python']
            },
            {
                title: 'Marketing Manager',
                industry: 'Marketing',
                experience: '8+ years',
                skills: ['Digital Marketing', 'SEO', 'Content Strategy', 'Analytics']
            },
            {
                title: 'Data Scientist',
                industry: 'Data',
                experience: '4+ years',
                skills: ['Python', 'Machine Learning', 'SQL', 'Statistics']
            }
        ];
    }

    getCareerTools() {
        return [
            { name: 'ATS Scanner', icon: 'fa-search', description: 'Check resume compatibility' },
            { name: 'Cover Letter Generator', icon: 'fa-file-alt', description: 'AI-powered letters' },
            { name: 'Job Matcher', icon: 'fa-briefcase', description: 'Find matching jobs' },
            { name: 'Salary Calculator', icon: 'fa-calculator', description: 'Estimate your worth' },
            { name: 'Interview Prep', icon: 'fa-comments', description: 'Practice questions' },
            { name: 'Skill Analyzer', icon: 'fa-chart-bar', description: 'Identify gaps' }
        ];
    }
}

// Initialize the application
const resumeAI = new ResumeAI();

// Make globally available
window.resumeAI = resumeAI;

// Expose helper functions
window.startBuilder = function() {
    resumeAI.createNewResume();
    // Navigate to builder page
    window.location.href = '/builder.html';
};

window.useTemplate = function(templateId) {
    if (typeof AdManager !== 'undefined') {
        AdManager.showAd('template').then(() => {
            resumeAI.createNewResume(templateId);
            window.location.href = '/builder.html';
        });
    } else {
        resumeAI.createNewResume(templateId);
        window.location.href = '/builder.html';
    }
};

window.exportResume = function(format) {
    resumeAI.exportResume(format);
};

window.toggleTheme = function() {
    resumeAI.toggleTheme();
};

// Handle page visibility
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Page is hidden, save state
        resumeAI.autoSave();
    } else {
        // Page is visible again
        resumeAI.trackEvent('page_visible');
    }
});

// Handle service worker updates
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
    });
}

console.log('ðŸŽ‰ ResumeAI Pro loaded successfully!');